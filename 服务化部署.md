4. 服务化部署¶
此步骤主要介绍如何将 PaddleOCR-VL 部署为服务并调用，有以下两种方式，任选一种即可：

方法一：使用 Docker Compose 部署（推荐使用）。

方法二：手动安装依赖部署。

请注意，本节所介绍 PaddleOCR-VL 服务与上一节中的 VLM 推理服务有所区别：后者仅负责完整流程中的一个环节（即 VLM 推理），并作为前者的底层服务被调用。

4.1 方法一：使用 Docker Compose 部署（推荐使用）¶
您可以从 此处 获取 Compose 文件并下载到本地，然后在刚刚下载的 Compose 文件目录下执行以下命令启动服务器，默认监听 8080 端口：


# 必须在 compose.yaml 文件所在的目录中执行
docker compose up
启动后将看到类似如下输出：


paddleocr-vl-api             | INFO:     Started server process [1]
paddleocr-vl-api             | INFO:     Waiting for application startup.
paddleocr-vl-api             | INFO:     Application startup complete.
paddleocr-vl-api             | INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
此方式基于 vLLM 框架对 VLM 推理进行加速，更适合生产环境部署，但要求机器配备 GPU，并且 NVIDIA 驱动程序支持 CUDA 12.6 或以上版本。

此外，使用此方式启动服务器后，除拉取镜像外，无需连接互联网。如需在离线环境中部署，可先在联网机器上拉取 Compose 文件中涉及的镜像，导出并传输至离线机器中导入，即可在离线环境下启动服务。

如需调整产线相关配置（如模型路径、批处理大小、部署设备等），可参考 4.4 小节。

4.2 方法二：手动安装依赖部署¶
执行以下命令，通过 PaddleX CLI 安装服务化部署插件：


paddlex --install serving
然后，使用 PaddleX CLI 启动服务器：


paddlex --serve --pipeline PaddleOCR-VL
启动后将看到类似如下输出，服务器默认监听 8080 端口：


INFO:     Started server process [63108]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
与服务化部署相关的命令行参数如下：

名称	说明
--pipeline	PaddleX 产线注册名或产线配置文件路径。
--device	产线部署设备。默认情况下，若 GPU 可用则使用 GPU，否则使用 CPU。
--host	服务器绑定的主机名或 IP 地址，默认为 0.0.0.0。
--port	服务器监听的端口号，默认为 8080。
--use_hpip	启用高性能推理模式。请参考高性能推理文档了解更多信息。
--hpi_config	高性能推理配置。请参考高性能推理文档了解更多信息。
如需调整产线相关配置（如模型路径、批处理大小、部署设备等），可参考 4.4 小节。

4.3 客户端调用方式¶
以下是服务化部署的 API 参考与多语言服务调用示例：

API 参考
对于服务提供的主要操作：

HTTP请求方法为POST。
请求体和响应体均为JSON数据（JSON对象）。
当请求处理成功时，响应状态码为200，响应体的属性如下：
名称	类型	含义
logId	string	请求的UUID。
errorCode	integer	错误码。固定为0。
errorMsg	string	错误说明。固定为"Success"。
result	object	操作结果。
当请求处理未成功时，响应体的属性如下：
名称	类型	含义
logId	string	请求的UUID。
errorCode	integer	错误码。与响应状态码相同。
errorMsg	string	错误说明。
服务提供的主要操作如下：

infer
进行版面解析。

POST /layout-parsing

请求体的属性如下：
名称	类型	含义	是否必填
file	string	服务器可访问的图像文件或PDF文件的URL，或上述类型文件内容的Base64编码结果。默认对于超过10页的PDF文件，只有前10页的内容会被处理。
要解除页数限制，请在产线配置文件中添加以下配置：

Serving:
  extra:
    max_num_input_imgs: null
是
fileType	integer｜null	文件类型。0表示PDF文件，1表示图像文件。若请求体无此属性，则将根据URL推断文件类型。	否
useDocOrientationClassify	boolean | null	请参阅产线对象中 predict 方法的 use_doc_orientation_classify 参数相关说明。	否
useDocUnwarping	boolean | null	请参阅PaddleOCR-VL对象中 predict 方法的 use_doc_unwarping 参数相关说明。	否
useLayoutDetection	boolean | null	请参阅PaddleOCR-VL对象中 predict 方法的 use_layout_detection 参数相关说明。	否
useChartRecognition	boolean | null	请参阅PaddleOCR-VL对象中 predict 方法的 use_chart_recognition 参数相关说明。	否
layoutThreshold	number | object | null	请参阅PaddleOCR-VL对象中 predict 方法的 layout_threshold 参数相关说明。	否
layoutNms	boolean | null	请参阅PaddleOCR-VL对象中 predict 方法的 layout_nms 参数相关说明。	否
layoutUnclipRatio	number | array | object | null	请参阅PaddleOCR-VL对象中 predict 方法的 layout_unclip_ratio 参数相关说明。	否
layoutMergeBboxesMode	string | object | null	请参阅PaddleOCR-VL对象中 predict 方法的 layout_merge_bboxes_mode 参数相关说明。	否
promptLabel	string | null	请参阅PaddleOCR-VL对象中 predict 方法的 prompt_label 参数相关说明。	否
formatBlockContent	boolean | null	请参阅PaddleOCR-VL对象中 predict 方法的 format_block_content 参数相关说明。	否
repetitionPenalty	number | null	请参阅PaddleOCR-VL对象中 predict 方法的 repetition_penalty 参数相关说明。	否
temperature	number | null	请参阅PaddleOCR-VL对象中 predict 方法的 temperature 参数相关说明。	否
topP	number | null	请参阅PaddleOCR-VL对象中 predict 方法的 top_p 参数相关说明。	否
minPixels	number | null	请参阅PaddleOCR-VL对象中 predict 方法的 min_pixels 参数相关说明。	否
maxPixels	number | null	请参阅PaddleOCR-VL对象中 predict 方法的 max_pixels 参数相关说明。	否
prettifyMarkdown	boolean	是否输出美化后的 Markdown 文本。默认为 true。	否
showFormulaNumber	boolean	输出的 Markdown 文本中是否包含公式编号。默认为 false。	否
visualize	boolean | null	是否返回可视化结果图以及处理过程中的中间图像等。
传入 true：返回图像。
传入 false：不返回图像。
若请求体中未提供该参数或传入 null：遵循配置文件Serving.visualize 的设置。

例如，在配置文件中添加如下字段：

Serving:
  visualize: False
将默认不返回图像，通过请求体中的visualize参数可以覆盖默认行为。如果请求体和配置文件中均未设置（或请求体传入null、配置文件中未设置），则默认返回图像。	否
请求处理成功时，响应体的result具有如下属性：
名称	类型	含义
layoutParsingResults	array	版面解析结果。数组长度为1（对于图像输入）或实际处理的文档页数（对于PDF输入）。对于PDF输入，数组中的每个元素依次表示PDF文件中实际处理的每一页的结果。
dataInfo	object	输入数据信息。
layoutParsingResults中的每个元素为一个object，具有如下属性：

名称	类型	含义
prunedResult	object	对象的 predict 方法生成结果的 JSON 表示中 res 字段的简化版本，其中去除了 input_path 和 page_index 字段。
markdown	object	Markdown结果。
outputImages	object | null	参见预测结果的 img 属性说明。图像为JPEG格式，使用Base64编码。
inputImage	string | null	输入图像。图像为JPEG格式，使用Base64编码。
markdown为一个object，具有如下属性：

名称	类型	含义
text	string	Markdown文本。
images	object	Markdown图片相对路径和Base64编码图像的键值对。
isStart	boolean	当前页面第一个元素是否为段开始。
isEnd	boolean	当前页面最后一个元素是否为段结束。
多语言调用服务示例
Python


import base64
import requests
import pathlib

API_URL = "http://localhost:8080/layout-parsing" # 服务URL

image_path = "./demo.jpg"

# 对本地图像进行Base64编码
with open(image_path, "rb") as file:
    image_bytes = file.read()
    image_data = base64.b64encode(image_bytes).decode("ascii")

payload = {
    "file": image_data, # Base64编码的文件内容或者文件URL
    "fileType": 1, # 文件类型，1表示图像文件
}

# 调用API
response = requests.post(API_URL, json=payload)

# 处理接口返回数据
assert response.status_code == 200
result = response.json()["result"]
for i, res in enumerate(result["layoutParsingResults"]):
    print(res["prunedResult"])
    md_dir = pathlib.Path(f"markdown_{i}")
    md_dir.mkdir(exist_ok=True)
    (md_dir / "doc.md").write_text(res["markdown"]["text"])
    for img_path, img in res["markdown"]["images"].items():
        img_path = md_dir / img_path
        img_path.parent.mkdir(parents=True, exist_ok=True)
        img_path.write_bytes(base64.b64decode(img))
    print(f"Markdown document saved at {md_dir / 'doc.md'}")
    for img_name, img in res["outputImages"].items():
        img_path = f"{img_name}_{i}.jpg"
        pathlib.Path(img_path).parent.mkdir(exist_ok=True)
        with open(img_path, "wb") as f:
            f.write(base64.b64decode(img))
        print(f"Output image saved at {img_path}")
C++
Java
Go
C#
Node.js
PHP
4.4 产线配置调整说明¶
若您无需调整产线配置，可忽略此小节。

调整服务化部署的 PaddleOCR-VL 配置只需以下三步：

生成配置文件
修改配置文件
应用配置文件
4.4.1 生成配置文件¶

paddlex --get_pipeline_config PaddleOCR-VL
4.4.2 修改配置文件¶
使用加速框架提升 VLM 推理性能

如需使用 vLLM 等加速框架提升 VLM 推理性能（第 2 节详细介绍如何启动 VLM 推理服务），可在产线配置文件中修改 VLRecognition.genai_config.backend 和 VLRecognition.genai_config.server_url 字段，例如：


VLRecognition:
  ...
  genai_config:
    backend: vllm-server
    server_url: http://127.0.0.1:8118/v1
启用文档图像预处理功能

默认配置启动的服务不支持文档预处理功能。若客户端调用该功能，将返回错误信息。如需启用文档预处理，请在产线配置文件中将 use_doc_preprocessor 设置为 True，并使用修改后的配置文件启动服务。

禁用结果可视化功能

服务默认返回可视化结果，这会引入额外开销。如需禁用该功能，可在产线配置文件中添加如下配置：


Serving:
  visualize: False
此外，也可在请求体中设置 visualize 字段为 false，以针对单次请求禁用可视化。

配置返回图像 URL

对于可视化结果图及 Markdown 中包含的图像，服务默认以 Base64 编码返回。如需以 URL 形式返回图像，可在产线配置文件中添加如下配置：


Serving:
  extra:
    file_storage:
      type: bos
      endpoint: https://bj.bcebos.com
      bucket_name: some-bucket
      ak: xxx
      sk: xxx
      key_prefix: deploy
    return_img_urls: True
目前支持将生成的图像存储至百度智能云对象存储（BOS）并返回 URL。相关参数说明如下：

endpoint：访问域名，必须配置。
ak：百度智能云 AK，必须配置。
sk：百度智能云 SK，必须配置。
bucket_name：存储空间名称，必须配置。
key_prefix：Object key 的统一前缀。
connection_timeout_in_mills：请求超时时间（单位：毫秒）。
有关 AK/SK 获取等更多信息，请参考 百度智能云官方文档。

修改 PDF 解析页数限制

出于性能考虑，服务默认仅处理接收到的 PDF 文件的前 10 页。如需调整页数限制，可在产线配置文件中添加如下配置：


Serving:
  extra:
    max_num_input_imgs: <新的页数限制，例如 100>
将 max_num_input_imgs 设置为 null 可解除页数限制。

4.4.3 应用配置文件¶
若您是 Docker Compose 部署：

将自定义的产线配置文件覆盖至 ccr-2vdh3abv-pub.cnc.bj.baidubce.com/paddlepaddle/paddleocr-vl（或对应容器）中的 /home/paddleocr/pipeline_config.yaml。

若您是手动安装依赖部署：

将 --pipeline 参数指定为自定义配置文件路径。